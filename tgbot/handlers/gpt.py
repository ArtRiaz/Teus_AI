import logging
import asyncio
from datetime import datetime
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, FSInputFile, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton
import os
from tgbot.config import load_config
import openai
from tgbot.keyboards.inline import get_exit_keyboard

config = load_config()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI
openai.api_key = config.tg_bot.openai

gpt_router = Router()
photo = FSInputFile("tgbot/app_main.png")


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —á–∞—Ç–∞ —Å –ò–ò
class AIStates(StatesGroup):
    chatting = State()


# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π Teus
KNOWLEDGE_BASE = """
–ö–û–ú–ü–ê–ù–ò–Ø TEUS - –õ–û–ì–ò–°–¢–ò–ß–ï–°–ö–ê–Ø –ö–û–ú–ü–ê–ù–ò–Ø

=== –î–û–ö–£–ú–ï–ù–¢–´ ===

CMR (–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è):
- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ 4 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, –ø–æ–ª—É—á–∞—Ç–µ–ª—å, –≥—Ä—É–∑, –≤–µ—Å, –º–∞—Ä—à—Ä—É—Ç
- –ü–æ–¥–ø–∏—Å–∏ –∏ –ø–µ—á–∞—Ç–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
- –ù–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö
- –î–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—Å–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ï–≤—Ä–æ–ø—ã

–¢–¢–ù (–¢–æ–≤–∞—Ä–Ω–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è):
- –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –ø–æ –£–∫—Ä–∞–∏–Ω–µ
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤
- –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 30 –¥–Ω–µ–π
- 2 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞: –≤–æ–¥–∏—Ç–µ–ª—å –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å

–ò–Ω–≤–æ–π—Å:
- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
- –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏
- –ù—É–∂–µ–Ω –¥–ª—è —Ç–∞–º–æ–∂–Ω–∏

–î–æ–∫—É–º–µ–Ω—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è:
–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ–π—Å—ã: –ø–∞—Å–ø–æ—Ä—Ç, –ø—Ä–∞–≤–∞, –º–µ–¥—Å–ø—Ä–∞–≤–∫–∞, —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ Green Card
–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ–π—Å—ã: –ø–∞—Å–ø–æ—Ä—Ç/ID, –ø—Ä–∞–≤–∞, –º–µ–¥—Å–ø—Ä–∞–≤–∫–∞

=== –ü–†–û–¶–ï–î–£–†–´ ===

–ó–∞–≥—Ä—É–∑–∫–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä—É–∑ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
2. –í–∑–≤–µ—Å–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–ø–∞–∫–æ–≤–∫—É –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É
4. –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–∑
5. –ü–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
6. –ó–∞–∫—Ä–µ–ø–∏—Ç—å –≥—Ä—É–∑ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º

–†–∞–∑–≥—Ä—É–∑–∫–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–æ–º–±—ã
2. –°–≤–µ—Ä–∏—Ç—å –≥—Ä—É–∑ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
5. –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π –ø—Ä–∏—Ü–µ–ø
6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É

–ü—Ä–µ–¥—Ä–µ–π—Å–æ–≤—ã–π –æ—Å–º–æ—Ç—Ä:
- –£—Ä–æ–≤–µ–Ω—å –º–∞—Å–ª–∞, —Ç–æ—Å–æ–ª–∞, —Ç–æ—Ä–º–æ–∑–Ω–æ–π –∂–∏–¥–∫–æ—Å—Ç–∏
- –î–∞–≤–ª–µ–Ω–∏–µ –≤ —à–∏–Ω–∞—Ö
- –†–∞–±–æ—Ç–∞ —Ç–æ—Ä–º–æ–∑–æ–≤ –∏ —Ä—É–ª–µ–≤–æ–≥–æ
- –û—Å–≤–µ—â–µ–Ω–∏–µ –∏ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –º–µ–¥–∫–æ–º–ø–ª–µ–∫—Ç

–¢–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:
1. –ü–æ–¥–∞—á–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. –¢–∞–º–æ–∂–µ–Ω–Ω—ã–π –¥–æ—Å–º–æ—Ç—Ä
3. –í–µ—Ç–∫–æ–Ω—Ç—Ä–æ–ª—å (–¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
4. –û–ø–ª–∞—Ç–∞ –ø–æ—à–ª–∏–Ω –∏ —Å–±–æ—Ä–æ–≤
5. –ü–æ–ª—É—á–µ–Ω–∏–µ —à—Ç–∞–º–ø–æ–≤

=== –ö–û–ù–¢–ê–ö–¢–´ TEUS ===

–î–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∞—è (24/7): +380XXXXXXXXX
–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è: +380XXXXXXXXX
–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +380XXXXXXXXX
–û—Ç–¥–µ–ª –ª–æ–≥–∏—Å—Ç–∏–∫–∏: +380XXXXXXXXX
–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è: +380XXXXXXXXX

=== –ú–ê–†–®–†–£–¢–´ ===

–ö–∏–µ–≤ ‚Üí –û–¥–µ—Å—Å–∞:
- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 475 –∫–º
- –í—Ä–µ–º—è: 5-6 —á–∞—Å–æ–≤
- –¢—Ä–∞—Å—Å–∞: –ú05
- –ó–∞–ø—Ä–∞–≤–∫–∏: –£–º–∞–Ω—å, –ü–µ—Ä–≤–æ–º–∞–π—Å–∫, –ù–∏–∫–æ–ª–∞–µ–≤
- –û—Ç–µ–ª–∏: –£–º–∞–Ω—å (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π), –ü–µ—Ä–≤–æ–º–∞–π—Å–∫ (–Æ–∂–Ω–∞—è –£–∫—Ä–∞–∏–Ω–∞)

–ö–∏–µ–≤ ‚Üí –õ—å–≤–æ–≤:
- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 540 –∫–º
- –í—Ä–µ–º—è: 6-7 —á–∞—Å–æ–≤
- –¢—Ä–∞—Å—Å–∞: –ú06
- –ó–∞–ø—Ä–∞–≤–∫–∏: –ñ–∏—Ç–æ–º–∏—Ä, –†–æ–≤–Ω–æ, –î—É–±–Ω–æ
- –û—Ç–µ–ª–∏: –ñ–∏—Ç–æ–º–∏—Ä (Premier), –†–æ–≤–Ω–æ (–£–∫—Ä–∞–∏–Ω–∞)

–ö–∏–µ–≤ ‚Üí –•–∞—Ä—å–∫–æ–≤:
- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 480 –∫–º
- –í—Ä–µ–º—è: 5-6 —á–∞—Å–æ–≤
- –¢—Ä–∞—Å—Å–∞: –ú03
- –ó–∞–ø—Ä–∞–≤–∫–∏: –ü–æ–ª—Ç–∞–≤–∞, –õ—É–±–Ω—ã
- –û—Ç–µ–ª–∏: –ü–æ–ª—Ç–∞–≤–∞ (–ì–∞–ª–∏—Ü–∫–∞—è), –õ—É–±–Ω—ã (–ú–∏—Ä)

–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã:
–ü–æ–ª—å—à–∞ - –ø—É–Ω–∫—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞: –ö—Ä–∞–∫–æ–≤–µ—Ü, –®–µ–≥–∏–Ω–∏, –ú–æ—Å—Ç–∏—Å–∫–∞ (–æ–∂–∏–¥–∞–Ω–∏–µ 2-4 —á–∞—Å–∞)
–†—É–º—ã–Ω–∏—è - –ø—É–Ω–∫—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞: –°–∏—Ä–µ—Ç, –ß–µ—Ä–Ω–æ–≤—Ü—ã (–æ–∂–∏–¥–∞–Ω–∏–µ 1-3 —á–∞—Å–∞)
–°–ª–æ–≤–∞–∫–∏—è - –ø—É–Ω–∫—Ç –ø—Ä–æ–ø—É—Å–∫–∞: –£–∂–≥–æ—Ä–æ–¥ (–æ–∂–∏–¥–∞–Ω–∏–µ 1-2 —á–∞—Å–∞)

=== –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–ú–û–©–¨ ===

–ß–∞—Å—Ç—ã–µ –ø–æ–ª–æ–º–∫–∏:

–ü–µ—Ä–µ–≥—Ä–µ–≤ –¥–≤–∏–≥–∞—Ç–µ–ª—è:
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ
- –ù–µ –≥–ª—É—à–∏—Ç—å —Å—Ä–∞–∑—É
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å —Ç–æ—Å–æ–ª–∞
- –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ—Ö–∞–Ω–∏–∫–æ–º

–ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–æ—Ä–º–æ–∑–∞–º–∏:
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
- –í–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω–∏–∫
- –í—ã–∑–≤–∞—Ç—å —ç–≤–∞–∫—É–∞—Ç–æ—Ä
- –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ

–°–ø—É—â–µ–Ω–Ω–æ–µ –∫–æ–ª–µ—Å–æ:
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –æ–±–æ—á–∏–Ω–µ
- –í–∫–ª—é—á–∏—Ç—å –∞–≤–∞—Ä–∏–π–∫—É
- –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞–∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- –ó–∞–º–µ–Ω–∏—Ç—å –∫–æ–ª–µ—Å–æ –∏–ª–∏ –≤—ã–∑–≤–∞—Ç—å –ø–æ–º–æ—â—å

–ü—Ä–æ–±–ª–µ–º—ã —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–µ–º–º—ã –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞
- –ü—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö - –≤ —Å–µ—Ä–≤–∏—Å

–°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã:
–ö–∏–µ–≤: –°–¢–û –ï–≤—Ä–æ–ø–∞ (+380XXXXXXXXX), –ú–µ–≥–∞–ø–æ–ª–∏—Å –ê–≤—Ç–æ (+380XXXXXXXXX)
–û–¥–µ—Å—Å–∞: –û–¥–µ—Å—Å–∞-–ê–≤—Ç–æ (+380XXXXXXXXX), –ü–æ—Ä—Ç-–°–µ—Ä–≤–∏—Å (+380XXXXXXXXX)
–õ—å–≤–æ–≤: –õ—å–≤–æ–≤-–¢—Ä–∞–Ω—Å (+380XXXXXXXXX), –ö–∞—Ä–ø–∞—Ç—ã-–ê–≤—Ç–æ (+380XXXXXXXXX)

=== –≠–ö–°–¢–†–ï–ù–ù–´–ï –°–ò–¢–£–ê–¶–ò–ò ===

–î–¢–ü:
1. –û–±–µ–∑–æ–ø–∞—Å–∏—Ç—å –º–µ—Å—Ç–æ
2. –í—ã–∑–≤–∞—Ç—å 102 (–ø–æ–ª–∏—Ü–∏—è) –∏ 103 (—Å–∫–æ—Ä–∞—è)
3. –£–≤–µ–¥–æ–º–∏—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ Teus
4. –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
5. –ù–ï –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –±–µ–∑ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
6. –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –æ –î–¢–ü

–ü–æ–ª–æ–º–∫–∞ –≤ –¥–æ—Ä–æ–≥–µ:
1. –í–∫–ª—é—á–∏—Ç—å –∞–≤–∞—Ä–∏–π–∫—É
2. –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞–∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (30–º –≤ –≥–æ—Ä–æ–¥–µ, 50–º –∑–∞ –≥–æ—Ä–æ–¥–æ–º)
3. –°–≤—è–∑–∞—Ç—å—Å—è —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º
4. –û–ø–∏—Å–∞—Ç—å –ø–æ–ª–æ–º–∫—É
5. –î–æ–∂–¥–∞—Ç—å—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

–ö—Ä–∞–∂–∞ –≥—Ä—É–∑–∞:
1. –í—ã–∑–≤–∞—Ç—å –ø–æ–ª–∏—Ü–∏—é 102
2. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–≤–æ–Ω–∏—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É
3. –ù–µ —Ç—Ä–æ–≥–∞—Ç—å –º–µ—Å—Ç–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è
4. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
5. –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –≤ –ø–æ–ª–∏—Ü–∏–∏

=== –†–ê–ë–û–¢–ê –° –ö–õ–ò–ï–ù–¢–ê–ú–ò ===

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
- –í–µ–∂–ª–∏–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è
- –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º —ç–∫—Å–ø–µ–¥–∏—Ç–æ—Ä–∞
- –ù–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≥—Ä—É–∑ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –°–æ–æ–±—â–∞—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É

–ü—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ:
- –ü—Ä–∏–±—ã—Ç—å –≤–æ–≤—Ä–µ–º—è
- –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º –∑–∞—Ä–∞–Ω–µ–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –∏ –ø–µ—á–∞—Ç—å
- –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ —Ä–∞–∑–≥—Ä—É–∑–∫–∏

–ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏:
- –û—Å—Ç–∞–≤–∞—Ç—å—Å—è —Å–ø–æ–∫–æ–π–Ω—ã–º
- –ù–µ —Å–ø–æ—Ä–∏—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
- –°–≤—è–∑–∞—Ç—å—Å—è —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã
- –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∫–æ–º–ø–∞–Ω–∏–∏

=== –ü–û–õ–ï–ó–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===

–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è:
- –ú–∞–∫—Å–∏–º—É–º 9 —á–∞—Å–æ–≤ –≤–æ–∂–¥–µ–Ω–∏—è –≤ –¥–µ–Ω—å
- –ú–∞–∫—Å–∏–º—É–º 56 —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–¥—ã—Ö 11 —á–∞—Å–æ–≤
- –ü–µ—Ä–µ—Ä—ã–≤ –∫–∞–∂–¥—ã–µ 4.5 —á–∞—Å–∞ (45 –º–∏–Ω—É—Ç)

–¢–∞—Ö–æ–≥—Ä–∞—Ñ:
- –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
- –ú–µ–Ω—è—Ç—å –∫–∞—Ä—Ç—É –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ä–æ–∫–∏
- –î–µ–ª–∞—Ç—å —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- –ù–µ –Ω–∞—Ä—É—à–∞—Ç—å —Ä–µ–∂–∏–º —Ç—Ä—É–¥–∞ –∏ –æ—Ç–¥—ã—Ö–∞

–¢–æ–ø–ª–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã:
- –ó–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ç–µ–≤—ã—Ö –ê–ó–°
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ —á–µ–∫–∏
- –ù–µ –¥–∞–≤–∞—Ç—å –∫–∞—Ä—Ç—É –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–º
- –°–æ–æ–±—â–∞—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∫–∞—Ä—Ç–æ–π

–°—Ç–æ—è–Ω–∫–∏:
- –û—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Å—Ç–æ—è–Ω–∫–∏ –¥–ª—è –Ω–æ—á–µ–≤–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –≤—ä–µ–∑–¥–µ
- –ù–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ
- –ü–ª–æ–º–±–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—Ü–µ–ø –Ω–∞ —Å—Ç–æ—è–Ω–∫–µ
"""

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
SYSTEM_PROMPT = f"""
–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Teus. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –≤–æ–¥–∏—Ç–µ–ª—è–º –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤.

–¢–í–û–Ø –†–û–õ–¨:
- –û–ø—ã—Ç–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ª–æ–≥–∏—Å—Ç–∏–∫–µ
- –í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ä–µ—à–∏—Ç—å —Ä–∞–±–æ—á–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ó–Ω–∞–µ—à—å –≤—Å–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–º–ø–∞–Ω–∏–∏ Teus
- –ì–æ–≤–æ—Ä–∏—à—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –ö–û–ú–ü–ê–ù–ò–ò:
{KNOWLEDGE_BASE}

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í:
1. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –≤—ã—à–µ
2. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
3. –ü—Ä–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å—Ä–∞–∑—É –¥–∞–≤–∞–π –Ω–æ–º–µ—Ä –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
4. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ - –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É
5. –ò—Å–ø–æ–ª—å–∑—É–π "—Ç—ã" –≤ –æ–±—â–µ–Ω–∏–∏
6. –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
7. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–º–æ—â—å

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–ò–¢–£–ê–¶–ò–ò (—Å—Ä–∞–∑—É –¥–∞–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã):
- –î–¢–ü, –ø–æ–ª–æ–º–∫–∏, –∫—Ä–∞–∂–∞
- –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏

–û—Ç–≤–µ—á–∞–π –Ω–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫–∞–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—å.
"""


@gpt_router.callback_query(F.data == "connect_ai")
async def start_ai_chat(callback: CallbackQuery, state: FSMContext):
    await callback.message.delete()

    welcome_text = """
**ü§ñ –Ü–Ü-–ê—Å–∏—Å—Ç–µ–Ω—Ç Teus**
–ü—Ä–∏–≤—ñ—Ç! –Ø —Ç–≤—ñ–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –ú–æ–∂—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –±—É–¥—å-—è–∫—ñ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ä–æ–±–æ—Ç—É:
üìã –î–æ–∫—É–º–µ–Ω—Ç–∏ (CMR, –¢–¢–ù, —ñ–Ω–≤–æ–π—Å–∏)
üöõ –ü—Ä–æ—Ü–µ–¥—É—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/—Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç–∏ —Ç–∞ –∑–∞–ø—Ä–∞–≤–∫–∏
üÜò –ï–∫—Å—Ç—Ä–µ–Ω—ñ —Å–∏—Ç—É–∞—Ü—ñ—ó
üîß –¢–µ—Ö–Ω—ñ—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞
üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏ —Å–ª—É–∂–±
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è...

"""

    await callback.message.answer(
        welcome_text,
        parse_mode="Markdown",
        reply_markup=get_exit_keyboard()
    )

    await state.set_state(AIStates.chatting)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ –∏–∑ —á–∞—Ç–∞
@gpt_router.message(F.text == "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —á–∞—Ç –∑ AI")
async def exit_ai_chat(message: Message, state: FSMContext):
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

    # –£–±–∏—Ä–∞–µ–º Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    await message.answer(
        "‚úÖ **–ß–∞—Ç –∑ AI –∑–∞–≤–µ—Ä—à–µ–Ω–æ**\n\n"
        "–î—è–∫—É—é –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!\n"
        "–Ø–∫—â–æ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–æ–ø–æ–º–æ–≥–∞ - –∑–≤–µ—Ä—Ç–∞–π—Å—è –∑–Ω–æ–≤—É! üòä",
        parse_mode="Markdown",
        reply_markup=ReplyKeyboardRemove()
    )

    kb = InlineKeyboardBuilder()
    kb.row(InlineKeyboardButton(text="ü§ñ –í—ñ–¥–∫—Ä–∏—Ç–∏ AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞", callback_data="connect_ai"))
    kb.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ —É –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu"))

    await message.answer(
        "üí¨ **–ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?**\n–ó–∞–ø–∏—Ç–∞–π —É AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!",
        reply_markup=kb.as_markup()
    )


@gpt_router.message(AIStates.chatting)
async def handle_ai_question(message: Message, state: FSMContext):
    user_question = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç
    await message.bot.send_chat_action(message.chat.id, "typing")

    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI (–Ω–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
        from openai import AsyncOpenAI

        client = AsyncOpenAI(api_key=openai.api_key)

        response = await client.chat.completions.create(
            model="gpt-4o-mini",  # –ù–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è –º–æ–¥–µ–ª—å
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "assistant", "content": user_question}
            ],
            max_tokens=800,
            temperature=0.3  # –ú–µ–Ω—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, –±–æ–ª—å—à–µ —Ç–æ—á–Ω–æ—Å—Ç–∏
        )

        ai_answer = response.choices[0].message.content

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await message.answer(
            ai_answer,
            parse_mode="Markdown",
            reply_markup=get_exit_keyboard()
        )

        logger.info(f"AI response sent to user {message.from_user.id}")

    except Exception as e:
        logger.error(f"Error with OpenAI: {e}")

        await message.answer(
            f"üìû **–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó:**\n–î–∏—Å–ø–µ—Ç—á–µ—Ä—Å—å–∫–∞: +380XXXXXXXXX",
            parse_mode="Markdown",
            reply_markup=get_exit_keyboard()
        )


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–µ —á–∞—Ç–∞ (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏)
@gpt_router.message(F.text)
async def suggest_ai_help(message: Message):
    kb = InlineKeyboardBuilder()
    kb.add(InlineKeyboardButton(text="ü§ñ –í—ñ–¥–∫—Ä–∏—Ç–∏ AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞", callback_data="connect_ai"))

    await message.answer(
        "üí¨ –ß–∏ —î —Ä–æ–±–æ—á–µ –ø–∏—Ç–∞–Ω–Ω—è? –ó–∞–ø–∏—Ç–∞–π —É AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!",
        reply_markup=kb.as_markup()
    )
