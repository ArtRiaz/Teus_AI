import logging
import asyncio
from datetime import datetime
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, FSInputFile, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton
import os
from tgbot.config import load_config
import openai
from tgbot.keyboards.inline import get_exit_keyboard

config = load_config()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI
openai.api_key = config.tg_bot.openai

gpt_router = Router()
photo = FSInputFile("tgbot/Support.png")


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —á–∞—Ç–∞ —Å –ò–ò
class AIStates(StatesGroup):
    chatting = State()


# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π Teus
KNOWLEDGE_BASE = """
–ö–û–ú–ü–ê–ù–Ü–Ø TEUS - –õ–û–ì–Ü–°–¢–ò–ß–ù–ê –ö–û–ú–ü–ê–ù–Ü–Ø

=== –û –ö–û–ú–ü–ê–ù–Ü–á ===

–ö–æ–º–ø–∞–Ω—ñ—è TEUS –ø—Ä–∞—Ü—é—î —É —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ-–ª–æ–≥—ñ—Å—Ç–∏—á–Ω—ñ–π –≥–∞–ª—É–∑—ñ –£–∫—Ä–∞—ó–Ω–∏ –∑ 2014 —Ä–æ–∫—É, –ø—Ä–æ–ø–æ–Ω—É—é—á–∏ –∫–ª—ñ—î–Ω—Ç–∞–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—ñ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ñ –ª–æ–≥—ñ—Å—Ç–∏—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è ¬´–ø—ñ–¥ –∫–ª—é—á¬ª, —è–∫—ñ –æ—Ö–æ–ø–ª—é—é—Ç—å —É—Å—ñ –µ—Ç–∞–ø–∏ –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É: –≤—ñ–¥ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å –¥–æ –ø–µ—Ä–µ–≤–∞–ª–∫–∏, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—ñ–≤ –∫—ñ–Ω—Ü–µ–≤–æ–º—É –æ—Ç—Ä–∏–º—É–≤–∞—á—É.

–ö–ª—é—á–æ–≤—ñ –ø–µ—Ä–µ–≤–∞–≥–∏ TEUS:
- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ñ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ñ –ª–æ–≥—ñ—Å—Ç–∏—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è ¬´–ø—ñ–¥ –∫–ª—é—á¬ª
- –ú—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è —Ä–∏–∑–∏–∫—ñ–≤ —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
- –®–∏—Ä–æ–∫–∞ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—è —Å–ø—ñ–≤–ø—Ä–∞—Ü—ñ –≤ –£–∫—Ä–∞—ó–Ω—ñ —Ç–∞ –Ñ–≤—Ä–æ–ø—ñ
- –ü–æ–≤–Ω–∏–π —Å–ø–µ–∫—Ç—Ä –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–∏—Ö –ø–æ—Å–ª—É–≥

=== –°–¢–†–£–ö–¢–£–†–ê –ö–û–ú–ü–ê–ù–Ü–á ===

–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –≤—ñ–¥–¥—ñ–ª–∏:
- –ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–π –≤—ñ–¥–¥—ñ–ª - –Ω–∞–¥—ñ–π–Ω–µ —Ç–∞ —Å–≤–æ—î—á–∞—Å–Ω–µ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—ñ–≤
- –ó–∞–ª—ñ–∑–Ω–∏—á–Ω–∏–π –≤—ñ–¥–¥—ñ–ª - –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –æ–±—Å—è–≥—ñ–≤ —Ç–∞ –¥–∞–ª–µ–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
- –°—Ç–∏–≤—ñ–¥–æ—Ä–Ω–∏–π –≤—ñ–¥–¥—ñ–ª - –ø–µ—Ä–µ–≤–∞–ª–∫–∞ –≤–∞–Ω—Ç–∞–∂—ñ–≤ —É –ø–æ—Ä—Ç–∞—Ö, —à–≤–∏–¥–∫–∞ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –æ–±—Ä–æ–±–∫–∞ —Ç–æ–≤–∞—Ä—ñ–≤
- –í—ñ–¥–¥—ñ–ª —Ñ—Ä–∞—Ö—Ç—É —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∏—Ö –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è –º–æ—Ä—Å—å–∫–∏—Ö –ø–µ—Ä–µ–≤–µ–∑–µ–Ω—å
- –í—ñ–¥–¥—ñ–ª —Ç—Ä–µ–π–¥–∏–Ω–≥—É - –¥–æ–ø–æ–º–æ–≥–∞ —É –∑–∞–∫—É–ø—ñ–≤–ª—è—Ö, –ø—Ä–æ–¥–∞–∂—É —Ç–∞ –æ–±–º—ñ–Ω—É —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö —Ä–∏–Ω–∫–∞—Ö

=== –ü–ê–†–¢–ù–ï–†–ò –¢–ê –ì–ï–û–ì–†–ê–§–Ü–Ø ===

–£ –∫–æ–º–ø–∞–Ω—ñ—ó —î –ø–∞—Ä—Ç–Ω–µ—Ä–∏ –≤:
- –ü–æ–ª—å—â—ñ
- –†—É–º—É–Ω—ñ—ó
- –°–ª–æ–≤–∞—á—á–∏–Ω—ñ
- –£–≥–æ—Ä—â–∏–Ω—ñ
- –ë–æ–ª–≥–∞—Ä—ñ—ó
- –ö—Ä–∞—ó–Ω–∞—Ö –ë–∞–ª—Ç—ñ—ó

=== –†–û–ó–í–ò–¢–û–ö –ö–û–ú–ü–ê–ù–Ü–á ===

–ü–æ—Ç–æ—á–Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å:
- –û–ø–µ—Ä—É—î 800 –æ—Ä–µ–Ω–¥–æ–≤–∞–Ω–∏–º–∏ –≤–∞–≥–æ–Ω–∞–º–∏
- –í–∂–µ —î 40 –≤–ª–∞—Å–Ω–∏—Ö –≤–∞–≥–æ–Ω—ñ–≤
- –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ –ø—Ä–∏–¥–±–∞–Ω–Ω—è —â–µ 70 –≤–ª–∞—Å–Ω–∏—Ö –≤–∞–≥–æ–Ω—ñ–≤
- –ú–µ—Ç–∞: —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –ø–∞—Ä–∫ –∑ 300 –≤–∞–≥–æ–Ω—ñ–≤

–ü–ª–∞–Ω–∏ —Ä–æ–∑–≤–∏—Ç–∫—É:
- –ü–æ–±—É–¥—É–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π –ø–æ—Ä—Ç–æ–≤–∏–π —Ç–µ—Ä–º—ñ–Ω–∞–ª
- –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–∫–ª–∞–¥—Å—å–∫—ñ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è
- –í—ñ–¥–∫—Ä–∏—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –∞–≥—Ä–∞—Ä–Ω–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤
- –†–æ–∑–≤–∏–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ñ —Ç–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è

–£ 2024 —Ä–æ—Ü—ñ —Ä–æ–∑—à–∏—Ä–∏–ª–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü—ñ—ó —É —Å—Ñ–µ—Ä—ñ –∞–≥—Ä–æ—Ç—Ä–µ–π–¥–∏–Ω–≥—É, –Ω–∞–¥–∞—é—á–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ –±—Ä–æ–∫–µ—Ä—Å—å–∫—ñ –ø–æ—Å–ª—É–≥–∏.

=== –ê–í–¢–û–ú–û–ë–Ü–õ–¨–ù–Ü –ü–ï–†–ï–í–ï–ó–ï–ù–ù–Ø ===

–ü–æ—Å–ª—É–≥–∏:
- –ê–≤—Ç–æ–ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –∑/–≤ –∫—Ä–∞—ó–Ω–∏ –Ñ–≤—Ä–æ–ø–∏, –∫—Ä–∞—ó–Ω–∏ –∫–æ–ª–∏—à–Ω—å–æ–≥–æ –°–ù–î —ñ —Å–µ—Ä–µ–¥–Ω—å–æ—ó –ê–∑—ñ—ó
- –î–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏—Ö —ñ –∑–±—ñ—Ä–Ω–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤
- –°–∞–º–æ—Å–∫–∏–¥–∏ –ø—ñ–¥ —Å–∏–ø—É—á—ñ –≤–∞–Ω—Ç–∞–∂—ñ –≤—ñ–¥ 25 —Ç–æ–Ω–Ω
- –ú–∏—Ç–Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—ñ–≤ –≤ —Ä–µ–∂–∏–º—ñ –µ–∫—Å–ø–æ—Ä—Ç —Ç–∞ —ñ–º–ø–æ—Ä—Ç
- –î–æ—Å—Ç–∞–≤–∫–∏ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–∏—Ö, –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—å –∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∏–º —Ä–µ–∂–∏–º–æ–º
- –î–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–≥–∞–±–∞—Ä–∏—Ç–Ω–∏—Ö —ñ –ø—Ä–æ–µ–∫—Ç–Ω–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤
- –°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—ñ–≤

=== –ü–û–†–¢–û–í–ê –õ–û–ì–Ü–°–¢–ò–ö–ê ===

–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ –ø–æ—Ä—Ç—ñ –ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫:
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –ø–æ—Ä—Ç–æ–≤–æ—ó –ª–æ–≥—ñ—Å—Ç–∏–∫–∏
- –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è —ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—è –∑ —Å—É–¥–Ω–æ–ø–ª–∞–≤–Ω–∏–º–∏ –ª—ñ–Ω—ñ—è–º–∏
- –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ –∑–µ—Ä–Ω–æ–≤–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤
- –°—É—á–∞—Å–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ
- –ì–Ω—É—á–∫—ñ —Å–∫–ª–∞–¥—Å—å–∫—ñ —Ä—ñ—à–µ–Ω–Ω—è
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- –ú—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ—Å—Ç–æ—ó–≤ —ñ —Ä–∏–∑–∏–∫—ñ–≤

–ü–µ—Ä–µ–≤–∞–ª–∫–∞ –∑–µ—Ä–Ω–æ–≤–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤ —É –ø–æ—Ä—Ç—É –ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫ - —Å–µ—Ä—Ü–µ –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–æ—ó –µ–∫—Å–ø–µ—Ä—Ç–∏–∑–∏ TEUS.

=== –ü–ê–ú'–Ø–¢–ö–ê –î–õ–Ø –í–û–î–Ü–Ø (–ü–û–†–¢ –ß–û–†–ù–û–ú–û–†–°–¨–ö) ===

–û—Å–Ω–æ–≤–Ω—ñ –≤–∏–º–æ–≥–∏:
1. –î–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—å –ü–î–† –£–∫—Ä–∞—ó–Ω–∏ —Ç–∞ –±—É—Ç–∏ –æ—Å–æ–±–ª–∏–≤–æ —É–≤–∞–∂–Ω–∏–º–∏
2. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –º—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —É –µ–∫—Å–ø–µ–¥–∏—Ç–æ—Ä–∞/–ø–æ—Ä—Ç–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
3. –†—É—Ö –¥–æ –ø–æ—Ä—Ç—É - –¢–Ü–õ–¨–ö–ò –∑–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø–µ—Ä–µ–ø—É—Å—Ç–∫–∏ —Ç–∞ —Ç–æ–≤–∞—Ä–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
4. –£—Ç–æ—á–Ω—é–≤–∞—Ç–∏ —É –∑–∞–º–æ–≤–Ω–∏–∫–∞ –∞–¥—Ä–µ—Å—É –ö–ü–ü –¥–ª—è –≤'—ó–∑–¥—É
5. –î–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—å –≥–∞–±–∞—Ä–∏—Ç–Ω–æ-–≤–∞–≥–æ–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
6. –ü–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –≤–∞–Ω—Ç–∞–∂—ñ–≤ - –∑–≥—ñ–¥–Ω–æ –∑ –Ω–æ—Ä–º–∞–º–∏ –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–∞
7. –®–≤–∏–¥–∫—ñ—Å—Ç—å —É –ø–æ—Ä—Ç—É –æ–±–º–µ–∂–µ–Ω–∞ –¥–æ 30 –∫–º/–≥–æ–¥
8. –ü—Ä–∏ –ø–æ–≤—ñ—Ç—Ä—è–Ω—ñ–π —Ç—Ä–∏–≤–æ–∑—ñ –ö–ü–ü –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å - –ø—Ä—è–º—É–≤–∞—Ç–∏ –¥–æ —É–∫—Ä–∏—Ç—Ç—è!

–ö–ê–¢–ï–ì–û–†–ò–ß–ù–û –ó–ê–ë–û–†–û–ù–ï–ù–û:
- –ó—É–ø–∏–Ω–∫–∞/—Å—Ç–æ—è–Ω–∫–∞ –Ω–∞ –≤—É–ª. –ü–µ—Ä–µ–º–æ–≥–∏ —Ç–∞ –≤—É–ª. –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞
- –°—Ç–æ—è–Ω–∫–∞ –±—ñ–ª—è –ö–ü–ü –ø–æ—Ä—Ç—É
- –¢–µ—Ö–Ω—ñ—á–Ω–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è, —Ä–µ–º–æ–Ω—Ç, –º–∏–π–∫–∞ –∞–≤—Ç–æ –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó –ø–æ—Ä—Ç—É
- –ó–∞—Å–º—ñ—á–µ–Ω–Ω—è –ø—Ä–æ—ó–∂–¥–∂–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –∞–±–æ —É–∑–±—ñ—á—á—è
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –≤–æ–≥–Ω–µ–º

–ü–û–ö–ê–†–ê–ù–ù–Ø: –î–æ –ø–æ—Ä—É—à–Ω–∏–∫—ñ–≤ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –∑–∞—Ö–æ–¥–∏ –≤–ø–ª–∏–≤—É, –≤–∫–ª—é—á–Ω–æ –∑ –∑–∞–±–æ—Ä–æ–Ω–æ—é –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–ø—É—Å—Ç–æ–∫!

–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:
‚ö†Ô∏è –°—Ç–µ–∂—Ç–µ –∑–∞ —Ç–µ—Ö–Ω—ñ—á–Ω–∏–º —Å—Ç–∞–Ω–æ–º –∞–≤—Ç–æ–º–æ–±—ñ–ª—è
‚ö†Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–∞ –≤–∞–Ω—Ç–∞–∂ —Ç–∞ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å
‚ö†Ô∏è –ó–∞–±–µ–∑–ø–µ—á—Ç–µ –ù–ê–õ–ï–ñ–ù–ï –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –≤–∞–Ω—Ç–∞–∂—É (–Ω–µ –Ω–µ–Ω–∞–ª–µ–∂–Ω–µ!)
‚ö†Ô∏è –î–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å —à–≤–∏–¥–∫—ñ—Å–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –≤ –ø–æ—Ä—Ç—É
‚ö†Ô∏è –§–æ—Ç–æ/–≤—ñ–¥–µ–æ–∑–π–æ–º–∫–∞ –≤ –ø–æ—Ä—Ç—É –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∞
‚ö†Ô∏è –ù–µ –≤–∂–∏–≤–∞–π—Ç–µ –∞–ª–∫–æ–≥–æ–ª—å —Ç–∞ –Ω–∞—Ä–∫–æ—Ç–∏—á–Ω—ñ –∑–∞—Å–æ–±–∏
‚ö†Ô∏è –í—Ä–∞—Ö–æ–≤—É–π—Ç–µ –ø–æ–≥–æ–¥–Ω—ñ —É–º–æ–≤–∏
‚ö†Ô∏è –ù–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –º–æ–±—ñ–ª—å–Ω–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∑–∞ –∫–µ—Ä–º–æ–º
"""

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
SYSTEM_PROMPT = f"""
–¢–∏ - –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –ª–æ–≥—ñ—Å—Ç–∏—á–Ω–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó Teus. –¢–∏ –¥–æ–ø–æ–º–∞–≥–∞—î—à –≤–æ–¥—ñ—è–º –≤–∞–Ω—Ç–∞–∂—ñ–≤–æ–∫.

–¢–í–û–Ø –†–û–õ–¨:
- –î–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –ª–æ–≥—ñ—Å—Ç–∏–∫–∏
- –ó–∞–≤–∂–¥–∏ –≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤–∏—Ä—ñ—à–∏—Ç–∏ —Ä–æ–±–æ—á—ñ –ø–∏—Ç–∞–Ω–Ω—è
- –ó–Ω–∞—î—à —É—Å—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ —Ç–∞ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–º–ø–∞–Ω—ñ—ó Teus
- –ì–æ–≤–æ—Ä–∏—à –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∞–ª–µ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ
- –¢–∏ –º–æ–∂–µ—à—å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ —Ä–æ–±–æ—á—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è, —è–∫—â–æ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è –æ—Å–æ–±–∏—Å—Ç—ñ, –∞–±–æ –º–∞—î –Ω–µ –µ—Ç–∏—á–Ω—É –Ω–æ—Ä–º—É —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è, –∑—Ä–æ–±–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è

–ë–ê–ó–ê –ó–ù–ê–ù–¨ –ö–û–ú–ü–ê–ù–Ü–á:
{KNOWLEDGE_BASE}d

–ü–†–ê–í–ò–õ–ê –í–Ü–î–ü–û–í–Ü–î–ï–ô:
1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å –≤–∏—â–µ
2. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ —Ç–∞ –ø–æ —Å—É—Ç—ñ
3. –ü—Ä–∏ –µ–∫—Å—Ç—Ä–µ–Ω–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ—è—Ö –æ–¥—Ä–∞–∑—É –¥–∞–≤–∞–π –Ω–æ–º–µ—Ä –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
4. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –Ω–∞–ø—Ä–∞–≤–ª—è–π –¥–æ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
5. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π "—Ç–∏" —É —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—ñ
6. –î–æ–¥–∞–≤–∞–π –µ–º–æ–¥–∑—ñ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Å–ø—Ä–∏–π–Ω—è—Ç—Ç—è
7. –ó–∞–≤–∂–¥–∏ –ø—Ä–æ–ø–æ–Ω—É–π –¥–æ–¥–∞—Ç–∫–æ–≤—É –¥–æ–ø–æ–º–æ–≥—É

–ö–†–ò–¢–ò–ß–ù–Ü –°–ò–¢–£–ê–¶–Ü–á (–æ–¥—Ä–∞–∑—É –¥–∞–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç–∏):
- –î–¢–ü, –ø–æ–ª–æ–º–∫–∏, –∫—Ä–∞–¥—ñ–∂–∫–∏
- –ü—Ä–æ–±–ª–µ–º–∏ –Ω–∞ –∫–æ—Ä–¥–æ–Ω—ñ
- –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏
- –¢–µ—Ö–Ω—ñ—á–Ω—ñ –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—ñ

–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∞–±–æ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é –º–æ–≤–æ—é, —è–∫ –ø–∏—Ç–∞—î –≤–æ–¥—ñ–π.

–í–ê–ñ–õ–ò–í–û: –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –Ω–∞ —Ç—ñ–π –º–æ–≤—ñ, —è–∫–æ—é –¥–æ —Ç–µ–±–µ –∑–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤–æ–¥—ñ–π - —è–∫—â–æ –ø–∏—Ç–∞—é—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, —è–∫—â–æ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é - —Ä–æ—Å—ñ–π—Å—å–∫–æ—é.

–°–¢–ò–õ–¨ –°–ü–Ü–õ–ö–£–í–ê–ù–ù–Ø:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–≤–µ—Ä—Ç–∞–Ω–Ω—è "–≤–æ–¥—ñ—é", "–∫–æ–ª–µ–≥–æ" –¥–ª—è –¥—Ä—É–∂–Ω–æ—Å—Ç—ñ
- –ë—É–¥—å –∫–æ—Ä–∏—Å–Ω–∏–º —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—é—á–∏–º
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø–æ—Ä–∞–¥–∏ —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö - –∑–∞—Å–ø–æ–∫–æ—é–π —Ç–∞ –Ω–∞–ø—Ä–∞–≤–ª—è–π –¥–æ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è
- –ó–∞–≤–∂–¥–∏ –Ω–∞–≥–∞–¥—É–π –ø—Ä–æ –±–µ–∑–ø–µ–∫—É –Ω–∞ –¥–æ—Ä–æ–∑—ñ

–ü–†–ò–ö–õ–ê–î–ò –í–Ü–î–ü–û–í–Ü–î–ï–ô:
–ü—Ä–∏ –µ–∫—Å—Ç—Ä–µ–Ω—ñ–π —Å–∏—Ç—É–∞—Ü—ñ—ó: "üö® –ù–ï–ì–ê–ô–ù–û –∑–≤'—è–∂–∏—Å—å –∑ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º: +380XXXXXXXXX"
–ü—Ä–∏ –∑–≤–∏—á–∞–π–Ω–æ–º—É –ø–∏—Ç–∞–Ω–Ω—ñ: "üöõ –î–æ–ø–æ–º–æ–∂—É! –û—Å—å —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏..."
–ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ: "‚úÖ –©–µ —â–æ—Å—å –ø–æ—Ç—Ä—ñ–±–Ω–æ? –ë–µ–∑–ø–µ—á–Ω–æ—ó –¥–æ—Ä–æ–≥–∏! üõ£Ô∏è"
"""


@gpt_router.callback_query(F.data == "connect_ai")
async def start_ai_chat(callback: CallbackQuery, state: FSMContext):
    await callback.message.delete()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    conversation_history = [
        {"role": "system", "content": SYSTEM_PROMPT}
    ]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM
    await state.update_data(conversation_history=conversation_history)

    welcome_text = """
**ü§ñ –Ü–Ü-–ê—Å–∏—Å—Ç–µ–Ω—Ç Teus**
–ü—Ä–∏–≤—ñ—Ç! –Ø —Ç–≤—ñ–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –ú–æ–∂—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –±—É–¥—å-—è–∫—ñ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ä–æ–±–æ—Ç—É:
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è...

"""

    await callback.message.answer(
        welcome_text,
        parse_mode="Markdown",
        reply_markup=get_exit_keyboard()
    )

    await state.set_state(AIStates.chatting)


@gpt_router.message(F.text == "‚òéÔ∏è –°–∫–ª–∞–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è")
async def exit_ai_chat(message: Message, state: FSMContext):
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞)
    await state.clear()

    # –£–±–∏—Ä–∞–µ–º Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    await message.answer(
        "‚úÖ **–ß–∞—Ç –∑ AI –∑–∞–≤–µ—Ä—à–µ–Ω–æ**\n\n"
        "–ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –∑–≤ º—è–∑–æ–∫ –∑ –Ω–∞—à–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º\n",
        parse_mode="Markdown",
        reply_markup=ReplyKeyboardRemove()
    )

    kb = InlineKeyboardBuilder()
    kb.row(InlineKeyboardButton(text="–ó–≤'—è–∑–æ–∫ –∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", url="https://t.me/"))
    kb.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ —É –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="back_main"))

    await message.answer(
        "üí¨ **–ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?**\n–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É —Ç–∞ –Ω–∞–ø–∏—à–∏—Ç—å –Ω–∞—à–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É",
        reply_markup=kb.as_markup()
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ –∏–∑ —á–∞—Ç–∞
@gpt_router.message(F.text == "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —á–∞—Ç –∑ AI")
async def exit_ai_chat(message: Message, state: FSMContext):
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞)
    await state.clear()

    # –£–±–∏—Ä–∞–µ–º Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    await message.answer(
        "‚úÖ **–ß–∞—Ç –∑ AI –∑–∞–≤–µ—Ä—à–µ–Ω–æ**\n\n"
        "–î—è–∫—É—é –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!\n"
        "–Ø–∫—â–æ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–æ–ø–æ–º–æ–≥–∞ - –∑–≤–µ—Ä—Ç–∞–π—Å—è –∑–Ω–æ–≤—É! üòä",
        parse_mode="Markdown",
        reply_markup=ReplyKeyboardRemove()
    )

    kb = InlineKeyboardBuilder()
    kb.row(InlineKeyboardButton(text="ü§ñ –í—ñ–¥–∫—Ä–∏—Ç–∏ AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞", callback_data="connect_ai"))
    kb.row(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ —É –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="back_main"))

    await message.answer(
        "üí¨ **–ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?**\n–ó–∞–ø–∏—Ç–∞–π —É AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!",
        reply_markup=kb.as_markup()
    )


@gpt_router.message(AIStates.chatting)
async def handle_ai_question(message: Message, state: FSMContext):
    user_question = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç
    await message.bot.send_chat_action(message.chat.id, "typing")

    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        conversation_history = data.get("conversation_history", [])

        # –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ), —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
        if not conversation_history:
            conversation_history = [
                {"role": "system", "content": SYSTEM_PROMPT}
            ]

        # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        conversation_history.append({
            "role": "user",
            "content": user_question
        })

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º system + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π)
        if len(conversation_history) > 21:  # system + 20 —Å–æ–æ–±—â–µ–Ω–∏–π
            conversation_history = [conversation_history[0]] + conversation_history[-20:]

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
        from openai import AsyncOpenAI

        client = AsyncOpenAI(api_key=openai.api_key)

        response = await client.chat.completions.create(
            model="gpt-4o-mini",  # –ù–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è –º–æ–¥–µ–ª—å
            messages=conversation_history,  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
            max_tokens=800,
            temperature=0.3  # –ú–µ–Ω—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, –±–æ–ª—å—à–µ —Ç–æ—á–Ω–æ—Å—Ç–∏
        )

        ai_answer = response.choices[0].message.content

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        conversation_history.append({
            "role": "assistant",
            "content": ai_answer
        })

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        await state.update_data(conversation_history=conversation_history)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await message.answer(
            ai_answer,
            parse_mode="Markdown",
            reply_markup=get_exit_keyboard()
        )

        logger.info(f"AI response sent to user {message.from_user.id}")

    except Exception as e:
        logger.error(f"Error with OpenAI: {e}")

        await message.answer(
            f"‚ùó **–ü–æ–º–∏–ª–∫–∞ AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞**\n\n"
            f"üìû **–î–ª—è —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ—ó –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó:**\n"
            f"–î–∏—Å–ø–µ—Ç—á–µ—Ä—Å—å–∫–∞: +380XXXXXXXXX (24/7)\n"
            f"–ï–∫—Å—Ç—Ä–µ–Ω–∞ –ª—ñ–Ω—ñ—è: +380XXXXXXXXX",
            parse_mode="Markdown",
            reply_markup=get_exit_keyboard()
        )


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
async def cleanup_long_conversations(state: FSMContext):
    """–û—á–∏—â–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏"""
    data = await state.get_data()
    conversation_history = data.get("conversation_history", [])

    # –ï—Å–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ
    if len(conversation_history) > 50:
        # –û—Å—Ç–∞–≤–ª—è–µ–º system –ø—Ä–æ–º–ø—Ç + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π
        conversation_history = [conversation_history[0]] + conversation_history[-30:]
        await state.update_data(conversation_history=conversation_history)
        logger.info("Conversation history cleaned up")


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–µ —á–∞—Ç–∞ (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏)
@gpt_router.message(F.text)
async def suggest_ai_help(message: Message):
    kb = InlineKeyboardBuilder()
    kb.add(InlineKeyboardButton(text="ü§ñ –í—ñ–¥–∫—Ä–∏—Ç–∏ AI-–ø–æ–º—ñ—á–Ω–∏–∫–∞", callback_data="connect_ai"))

    await message.answer(
        "üí¨ –ß–∏ —î —Ä–æ–±–æ—á–µ –ø–∏—Ç–∞–Ω–Ω—è? –ó–∞–ø–∏—Ç–∞–π —É AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ Teus!",
        reply_markup=kb.as_markup()
    )


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
@gpt_router.message(F.text.startswith("/debug_conversation"))
async def debug_conversation(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)"""
    data = await state.get_data()
    conversation_history = data.get("conversation_history", [])

    stats = f"""
üîç **Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
–°–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: {len(conversation_history)}
–°–æ—Å—Ç–æ—è–Ω–∏–µ: {await state.get_state()}
–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {len(str(conversation_history))} —Å–∏–º–≤–æ–ª–æ–≤
    """

    await message.answer(stats, parse_mode="Markdown")